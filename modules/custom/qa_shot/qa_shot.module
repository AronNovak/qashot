<?php

/**
 * @file
 * Contains qa_shot.module..
 */

use \Drupal\Core\Routing\RouteMatchInterface;
use \Drupal\Core\Form\FormStateInterface;
use \Drupal\Core\Entity\EntityInterface;
use \Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use \Drupal\qa_shot\Entity\QAShotTest;
use Drupal\qa_shot\Plugin\Field\FieldType\Viewport;
use Drupal\qa_shot\Plugin\Field\FieldType\Scenario;
use Drupal\Core\StreamWrapper\PrivateStream;
use Drupal\Core\StreamWrapper\PublicStream;

/**
 * Implements hook_help().
 */
function qa_shot_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the qa_shot module.
    case 'help.page.qa_shot':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Module for test management.') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_cron().
 */
function qa_shot_cron() {
  // @todo: run scheduled tests
}

/**
 * Implements hook_theme().
 */
function qa_shot_theme($existing, $type, $theme, $path) {
  return [
    'qa_shot__qa_shot_test__run' => [
      'template' => 'qa_shot_test--run',
      'variables' => [
        'entity' => NULL,
        'html_report_url' => NULL,
      ],
    ],
  ];
}

/**
 * Implements hook_form_alter().
 *
 * @param $form
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 * @param $form_id
 */
function qa_shot_form_alter(
  &$form,
  FormStateInterface $form_state,
  $form_id
) {
  if (in_array($form_id, ["qa_shot_test_edit_form"])) {
    $form['actions']['run'] = array(
      '#type' => 'submit',
      '#value' => t('Run Test'),
      '#weight' => $form['actions']['submit']['#weight'] + 1,
      // '#ajax' => ['callback' => [$this, 'ajaxCallback']], //.
      '#submit' => array("qa_shot_qa_shot_test_run_handler"),
    );
  }
}

/**
 * Handler function for the "Run test" button.
 *
 * @param $form
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 */
function qa_shot_qa_shot_test_run_handler(&$form, FormStateInterface $form_state) {
  /** @var QAShotTest $entity */
  $entity = $form_state->getFormObject()->getEntity();

  $form_state->setRedirect(
    "entity.qa_shot_test.run",
    [
      "qa_shot_test" => $entity->id(),
    ],
    [
      'query' => [
        'start_now' => TRUE,
      ],
    ]
  );
}

/**
 * Helper function for running a complete testcase.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 */
function _qa_shot_run_test_for_entity(EntityInterface $entity) {
  if (empty($entity) || !($entity instanceof QAShotTest)) {
    drupal_set_message(t("Trying to run test for an empty or invalid entity."), "error");
  }

  try {
    _qa_shot_initialize_backstop_environment($entity);
  }
  catch (\Exception $exception) {
    dpm($exception->getMessage(), "Exception at entity insert.");
  }

  if (empty($entity->field_configuration_path->getValue())) {
    dpm("Configuration path not saved in entity.");
    return;
  }

  $command = "reference";
  if (FALSE === _qa_shot_run_backstop_command($command, $entity->get("field_configuration_path")->value)) {
    dpm("Running the " . $command . " command has failed.");
    return;
  }

  $command = "test";
  if (FALSE === _qa_shot_run_backstop_command($command, $entity->get("field_configuration_path")->value)) {
    dpm("Running the " . $command . " command has failed.");
    return;
  }

}

/**
 * Implements hook_ENTITY_TYPE_delete().
 */
function qa_shot_qa_shot_test_delete(EntityInterface $entity) {
  // @todo: move this to a config
  $customDataBase = "qa_test_data";

  // @todo: . "/" . revision id; to both paths!
  $privateDataPath = PrivateStream::basePath() . "/" . $customDataBase . "/" . $entity->id();
  $publicDataPath = PublicStream::basePath() . "/" . $customDataBase . "/" . $entity->id();

  $removeResult = _qa_shot_remove_directory($privateDataPath);
  dpm($removeResult ? "PrivateFolder removed" : "Private folder not removed");
  $removeResult = _qa_shot_remove_directory($publicDataPath);
  dpm($removeResult ? "PubFolder removed" : "Pub folder not removed");
}

/**
 * Implements hook_ENTITY_TYPE_view().
 */
function qa_shot_qa_shot_test_view(
  array &$build,
  EntityInterface $entity,
  EntityViewDisplayInterface $display,
  $view_mode
) {
  // @todo: save paths in the entity

  // dpm($genResult["data"]["reportPath"], "report path");
  dpm(array(
    "entity_conf_path" => $entity->get('field_configuration_path')->value,
    "entity_report_path" => $entity->get('field_html_report_path')->value,
  ), "entity");

  // @todo: major cleanup and restructuring of the files
  // @todo: store paths in db

  // dpm($entity->getBackstopConfigurationPath(), "config path from entity");//.
}

/**
 * Function that initializes a backstop configuration for the entity.
 *
 * Does the following:
 *    Creates the folder for the entity,
 *    Creates the backstop.json file,
 *    Copies template files to the proper directories,
 *    Saves some data to the entity.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The QAShot Test entity.
 *
 * @throws \Exception
 */
function _qa_shot_initialize_backstop_environment(EntityInterface &$entity) {
  if (empty($entity) || $entity->getEntityTypeId() != 'qa_shot_test') {
    throw new \Exception("The entity is empty or its type is not QAShot Test!");
  }

  $customDataBase = "qa_test_data";

  /** @var \Drupal\Core\File\FileSystem $fs */
  $fs = \Drupal::service('file_system');

  // @todo: refactor
  // @todo: . "/" . revision id; to both paths.
  $privateEntityData = PrivateStream::basePath() . "/" . $customDataBase . "/" . $entity->id();
  $publicEntityData = PublicStream::basePath() . "/" . $customDataBase . "/" . $entity->id();
  $templateFolder = PrivateStream::basePath() . "/" . $customDataBase . "/template";
  $configPath = $privateEntityData . "/backstop.json";

  $configAsArray = _qa_shot_map_entity_to_backstop_config_array($entity, $privateEntityData, $publicEntityData);
  $jsonConfig = JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE;
  $configAsJSON = json_encode($configAsArray, $jsonConfig);

  $privateCasperFolder = $configAsArray["paths"]["casper_scripts"];
  $reportPath = $configAsArray["paths"]["html_report"] . "/index.html";

  dpm(array(
    "privateEntityData" => $privateEntityData,
    "publicEntityData" => $publicEntityData,
    "templates" => $templateFolder,
    "config" => $configPath,
    "casperFolder" => $privateCasperFolder,
    "reportFolder" => $reportPath,
    "entityCasperScripts" => $configAsArray["paths"]["casper_scripts"],
  ), "new paths");

  // @todo: maybe use drupal functions for file handling
  // @todo: This was $privateTestBaseFolder
  if (FALSE === _qa_shot_create_folder_for_entity($privateEntityData)) {
    throw new \Exception("Creating the private base folder at " . $privateEntityData . " for the entity failed.");
  }
  // @todo: this was $privateConfigurationFile
  if (FALSE === _qa_shot_create_backstop_config_file($configPath, $configAsJSON)) {
    throw new \Exception("Creating the configuration file at " . $configPath . " failed.");
  }

  if (FALSE === _qa_shot_create_folder_for_entity($privateCasperFolder)) {
    throw new \Exception("Creating the folder for casper scripts at " . $privateCasperFolder . " failed.");
  }

  if (FALSE === _qa_shot_copy_template_data($templateFolder . "/casper_scripts", $configAsArray["paths"]["casper_scripts"])) {
    throw new \Exception("Copying the template casper scripts failed.");
  }

  if (
    $entity->get("field_configuration_path")->value !== $configPath ||
    $entity->get("field_html_report_path")->value !== $reportPath
  ) {
    $entity->set("field_configuration_path", $configPath);
    $entity->set("field_html_report_path", $reportPath);
    $entity->save();
  }
}

/**
 * @param $command
 * @param $configurationPath
 *
 * @return bool
 */
function _qa_shot_run_backstop_command($command, $configurationPath) {
  // @todo: use exceptions instead of return bool
  if (!in_array($command, array("reference", "test"))) {
    return FALSE;
  }

  // @todo: send this to the background, don't hold up UI
  // @todo: add some kind of semaphore to prevent running a test several times at the same time
  /*
   * @todo: real-time output:
   *    http://stackoverflow.com/questions/1281140/run-process-with-realtime-output-in-php
   *    http://stackoverflow.com/questions/20614557/php-shell-exec-update-output-as-script-is-running
   *    http://stackoverflow.com/questions/20107147/php-reading-shell-exec-live-output
   */

  // @todo: FIXME.
  // @todo: Get node version from .amazee.yml and add /var/www/drupal/.nvm/versions/node/v{node_vresion}/bin to path.
  $backstopCommand = escapeshellcmd('/var/www/drupal/.nvm/versions/node/v6.5.0/bin/backstop ' . $command . ' --configPath=' . $configurationPath);
  exec($backstopCommand, $execOutput, $status);

  dpm($status, "exec status");

  if ($status !== 0) {
    // @todo: Test command gives exit 1 if the compare fails.
    // Search this line: "Bitmap file generation completed."
    // And/Or this line: "COMMAND | Executing core for `report`".
    dpm($execOutput, "Output of exec.");

    return FALSE;
  }

  return TRUE;
}

/**
 * @param $src
 * @param $target
 *
 * @return bool
 */
function _qa_shot_copy_template_data($src, $target) {
  // @todo: use exceptions
  dpm($src, "copy src");
  dpm($target, "copy target");

  if (($fileList = scandir($src)) === FALSE) {
    dpm("scandir failed");
    return FALSE;
  }

  // @todo: scandir target, if file is there and they are the same, skip the file

  $result = TRUE;

  foreach ($fileList as $file) {
    if (strpos($file, ".js") === FALSE) {
      continue;
    }

    $result |= copy($src . "/" . $file, $target . "/" . $file);
  }

  return $result;
}

/**
 * @param $configurationPath
 * @param $jsonString
 *
 * @return bool
 */
function _qa_shot_create_backstop_config_file($configurationPath, $jsonString) {
  // @todo: throw exceptions
  // @todo: check if file exists, if yes, check if it's the same as the new one.
  // if yes, skip
  if (($configFile = fopen($configurationPath, "w")) === FALSE) {
    dpm("failed to open config file to write");
    return FALSE;
  }

  if (fwrite($configFile, $jsonString) === FALSE) {
    dpm("failed to write config file");
    return FALSE;
  }

  if (fclose($configFile) === FALSE) {
    dpm("failed to close config file");
    return FALSE;
  }

  dpm("config write success");

  return TRUE;
}

/**
 * Creates a directory at the given path.
 *
 * @param string $dirToCreate
 *   Path of the directory to be created.
 *
 * @return bool
 *   Whether the folder exists or creating it succeeded.
 */
function _qa_shot_create_folder_for_entity($dirToCreate) {
  if (is_dir($dirToCreate)) {
    return TRUE;
  }

  // Create directory and parents as well.
  return mkdir($dirToCreate, 0775, TRUE);
}

/**
 * Helper function which maps the entity fields to an array.
 *
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The QAShot Test entity.
 * @param string $privateDataPath
 *   Path to the private filesystem.
 * @param string $publicDataPath
 *   Path to the public filesystem.
 *
 * @return array
 *   A backstop config as an array.
 */
function _qa_shot_map_entity_to_backstop_config_array(EntityInterface $entity, $privateDataPath, $publicDataPath) {
  // @todo: get these field values global settings

  $mapConfigToArray = [
    // @todo: maybe id + revision id.
    "id" => $entity->id(),
    "viewports" => [],
    "scenarios" => [],
    "paths" => [
      "bitmaps_reference" => $publicDataPath . "/reference",
      "bitmaps_test" => $publicDataPath . "/test",
      "casper_scripts" => $privateDataPath . "/casper_scripts",
      "html_report" => $publicDataPath . "/html_report",
      "ci_report" => $publicDataPath . "/ci_report",
    ],
    // "onBeforeScript" => "onBefore.js", //.
    // "onReadyScript" => "onReady.js", //.
    "engine" => "phantomjs",
    "report" => [
      "browser",
    ],
    "casperFlags" => [
      "--ignore-ssl-errors=true",
      "--ssl-protocol=any",
    ],
    "debug" => FALSE,
  ];

  foreach ($entity->field_viewport as $viewport) {
    $mapConfigToArray["viewports"][] = _qa_shot_map_viewport_to_array($viewport);
  }

  foreach ($entity->field_scenario as $scenario) {
    $mapConfigToArray["scenarios"][] = _qa_shot_map_scenario_to_array($scenario);
  }

  $debugMode = FALSE;
  if ($debugMode === TRUE) {
    $mapConfigToArray['debug'] = TRUE;
    $mapConfigToArray['casperFlags'][] = "--verbose";
  }

  return $mapConfigToArray;
}

/**
 * Maps the values of a scenario field to an array.
 *
 * @param Scenario $scenario
 *
 * @return array
 */
function _qa_shot_map_scenario_to_array(Scenario $scenario) {
  return array(
    "label" => (string) $scenario->get("label")->getValue(),
    "referenceUrl" => (string) $scenario->get("referenceUrl")->getValue(),
    "url" => (string) $scenario->get("testUrl")->getValue(),
    "readyEvent" => NULL,
    "delay" => 5000,
    "misMatchThreshold" => 0.0,
    "selectors" => [
      "document",
    ],
    "removeSelectors" => [
      "#twitter-widget-0",
      "#twitter-widget-1",
      ".captcha",
      "#sliding-popup",
    ],
    "hideSelectors" => [],
    "onBeforeScript" => "onBefore.js",
    "onReadyScript" => "onReady.js",
  );
}

/**
 * Maps a viewport field to an array.
 *
 * @param Viewport $viewport
 *
 * @return array
 */
function _qa_shot_map_viewport_to_array(Viewport $viewport) {
  return array(
    "name" => (string) $viewport->get("name")->getValue(),
    "width" => (int) $viewport->get("width")->getValue(),
    "height" => (int) $viewport->get("height")->getValue(),
  );
}

/**
 * @param string $dir
 *
 * @return bool
 */
function _qa_shot_remove_directory($dir) {
  if (!is_dir($dir)) {
    return TRUE;
  }

  $it = new RecursiveDirectoryIterator($dir, RecursiveDirectoryIterator::SKIP_DOTS);
  $files = new RecursiveIteratorIterator($it,
    RecursiveIteratorIterator::CHILD_FIRST);

  $result = TRUE;

  foreach ($files as $file) {
    if ($file->isDir()) {
      $result |= rmdir($file->getRealPath());
    }
    else {
      $result |= unlink($file->getRealPath());
    }
  }
  $result |= rmdir($dir);

  return $result;
}